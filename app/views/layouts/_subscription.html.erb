<%= subscribe_to "/messages/#{current_user.id}" if signed_in?%>
<script>
  PrivatePub.subscribe("/messages/<%= current_user.id %>", function(data, channel) {
    if (data.type === 1) onChatMessage(data.message);
    else if (data.type === 2) removeUser(data.user_id); 
    console.log(data);
  });
  (function poll(){
  setTimeout(function(){
    $.ajax({ 
      url: "http://localhost:3000/refresh", 
      type: "GET",
      dataType: "json",
      data: {"users": getUidsFromUserList()},
      success: function(data){
        updateOnlineStatus(data.uids);  
        //Setup the next poll recursively
        poll();
      }
    });
    }, 30000);
  })();  
</script>
<%= online_users %>
