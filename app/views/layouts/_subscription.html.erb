<%= subscribe_to "/messages/#{current_user.id}" if signed_in?%>
<script>
  PrivatePub.subscribe("/messages/<%= current_user.id %>", function(data, channel) {
    // 消息类型详见文档
    switch(data.type) {
      case 1: 
        onNewMessage(data.message);
        break;
      case 2:
        removeUser(data.user_id); 
        break;
      case 3:
        addUser(data.user.id, data.user.name, data.user.online);
        break;
      case 4:
        onGroupChatMessage(data.message, data.room_id);
        break;
    }
    console.log(data);
  });
  function poll(){
    setTimeout(function(){
      refresh();
    }, 30000);
  }  
  function refresh() {
    $.ajax({ 
      url: "http://localhost:3000/refresh", 
      type: "GET",
      dataType: "json",
      data: {"users": getUidsFromUserList()},
      success: function(data){
        updateOnlineStatus(data.uids);  
        //Setup the next poll recursively
        poll();
      }
    });
  }
  refresh();
</script>
